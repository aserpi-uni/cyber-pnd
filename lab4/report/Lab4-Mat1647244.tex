\documentclass[draft]{homework}

\usepackage{graphicx}
\usepackage{xspace}


\newcommand{\kat}{Kathar√°\xspace}
\newcommand{\opn}{OPNsense\xspace}
\newcommand{\vb}{VirtualBox\xspace}

\newcommand{\client}{\textit{client}\xspace}
\newcommand{\dmz}{\textit{DMZ}\xspace}
\newcommand{\ser}{\textit{internal server}\xspace}
\newcommand{\intfw}{\textit{intfw}\xspace}
\newcommand{\mainfw}{\textit{mainfw}\xspace}

\newcommand{\lan}{\textit{LAN}\xspace}
\newcommand{\opt}{\textit{OPT1}\xspace}
\newcommand{\wan}{\textit{WAN}\xspace}


\title{Practical Network Defense - Lab 4}
\author{Alessandro Serpi - 1647244}
\date{22 March 2019}


\begin{document}
    \maketitle
    \tableofcontents
    
    
    \section{Introduction}
    The private network of \textit{ACME co.} is composed by four subnetworks living in the shared address space \texttt{100.64.0.0/16}. \dmz is connected directly to the main firewall-router \mainfw and offers services accessible from the external network, while \client and \ser networks are behind a second line of defence (represented by the internal firewall-router \intfw). The latter offers services that may be used only by hosts in the private network, whereas the former does not offer any services.
    
    All hosts are already configured (however, minor adjustment may be made), with the exception of the firewalls, that have yet to be created. 
    
    
    \section{Setup of the infrastructure}
    \subsection{Disabling checksum offload}
    The command \texttt{ethtool -K eth0 tx off} was added to every \texttt{.startup} file. This disables the checksum computation offload to the network card; instead, the hosts rely on the CPU to calculate the packet checksums. It is slower, but creates less problems with \opn.
    In \opn, checksum offload is disabled by default.
    
    \subsection{Enabling recursive DNS queries}
    Recursive DNS queries are not permitted, but this clashes with the fact that client hosts are allowed to retrieve web pages from the internet. Therefore, it has been decided to allow recursive DNS queries adding the clause \texttt{recursion yes;} in \texttt{dns/etc/named.conf}, section \texttt{options}.
    
    It has also decided that hosts in the \dmz and in the \ser networks should not be interested in retrieving IP addresses of external websites. Hence, recursive DNS queries have been allowed only for \client network.
    
    \subsection{Creating and configuring the VMs}
    Create in \vb two virtual machine, one for \mainfw and the other for \intfw, each with its own disk. Download the ISO installer from \opn's \href{https://opnsense.org/download/}{official website} and add it to the virtual machines. \href{https://docs.opnsense.org/manual/install.html}{Install} \opn in both machine, then power them off and remove the ISO.
    Finally, add to \mainfw one NAT network card and two bridge adapters and add to \intfw three bridge adapters.
    
    \subsection{Starting the lab}
    Every time it is necessary to launch the lab, use \texttt{lstart} to initiate \kat and then execute \texttt{start\_vms.sh}.
    The script automatically configures the virtual network cards and powers up the virtual machines. 
    
    \subsection{Configuring the interfaces}
    Power up both virtual machine, login as root and enter interface assignment menu. Use \texttt{em0} as \wan, \texttt{em1} as \opt and \texttt{em2} as \lan.
    
    Enter the IP address configuration menu. In \mainfw, configure \wan to use DHCP, assign \texttt{100.64.254.1/30} to \lan and \texttt{100.64.6.1/24} to \opt; in \intfw, assign address \texttt{100.64.254.2/30} and gateway \texttt{100.64.254.1} to \wan, address \texttt{100.64.2.1/24} to \lan and \texttt{100.64.1.1/24} to \opt.
    
    \subsection{Setting up \opn}
    In \mainfw, enter the shell and execute \texttt{route add -inet 100.64.0.0/16 -link \\ 100.64.254.2}. This is a temporary measure in order to access the web GUI from the host. From now on, all operations will be executed through the GUI, accessible at \url{https://100.64.254.1} for \mainfw and \url{https://100.64.2.1} for \intfw. In \mainfw, add route \texttt{100.64.0.0/16} using gateway \texttt{100.64.254.2}.
    
    Disable outbound NAT in \intfw (unnecessary, as it is an internal firewall) and outbound DNS in both machines (DNS servers are configured statically in each host). In \mainfw, set outbound NAT in manual mode and create a rule for NATting the traffic that leaves the private network.
    
    
    \section{Evaluation of the security policy}
    \subsection{DNS}
    All internal hosts should be able to resolve internal domain names.
    Since devices in the \textit{client} network are the only ones that can access external web services, no other host should be able to resolve external domains,
    
    \subsection{FTP}
    All internal hosts should be able to connect to the internal FTP server, while only devices in \textit{client} network should be able to connect to external ones.
    External hosts should be able to connect to the internal FTP server.
    
    \subsection{HTTP/HTTPS}
    All internal hosts should be able to connect to the internal web server, while only devices in \textit{client} network should be able to connect to external websites and to the firewall-router administration pages.
    External hosts should be able to connect to the internal web server.
    
    \subsection{SSH}
    Hosts in \textit{client} network should be able to use the SSH protocol in the internal network.
    No other use is authorised.
    
    \subsection{Syslog}
    Internal hosts should be able to send logging messages to the syslog server.
    No other use is authorised.
    
    
    \section{Policy implementation in \opn}
    \fxnote{TODO}
    
    
    \section{Test of the configuration}
    In the root directory of each \kat  host there is an executable script \texttt{$\langle$host$\rangle$.test} that checks the firewall and DNS functionality.
    The return code is a 4-bit flag:
    \begin{itemize}
        \item \texttt{0001}: error on DNS resolution of internal hosts
        \item \texttt{0010}: error on DNS resolution of external hosts
        \item \texttt{0100}: error on internal web connectivity
        \item \texttt{1000}: error on external web connectivity.
    \end{itemize}
    
    Given that \textit{expect} is not installed and both \textit{ftp} and \textit{ssh} clients can not be reliably used with simple bash scripts, testing the corresponding protocols must be done manually, checking the connectivity for each host.
    
    
    \section{Final remarks}
    When checksum offload is activated, all packets passing through the firewall get corrupted. Disabling it on the host's virtual interfaces produce no effects, it must be done from the \kat hosts.
    
    In theory, outbound NAT should be disabled in \mainfw, as \vb already takes care of translating the IP addresses. In practice, disabling it conflicts with the configuration script.
\end{document}
