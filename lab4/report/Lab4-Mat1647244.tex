\documentclass[draft]{homework}

\usepackage{xspace}

\newcommand{\intfw}{\texttt{intfw}\xspace}
\newcommand{\kat}{Kathar√°\xspace}
\newcommand{\mainfw}{\texttt{mainfw}\xspace}
\newcommand{\opn}{OPNsense\xspace}
\newcommand{\vb}{VirtualBox\xspace}


\title{Practical Network Defense - Lab 4}
\author{Alessandro Serpi - 1647244}
\date{22 March 2019}


\begin{document}
    \maketitle
    \tableofcontents
    
    
    \section{Introduction}
    The private network of \textit{ACME co.} is composed by four subnetworks living in the shared address space \texttt{100.64.0.0/16}. \textit{DMZ} is connected directly to the main firewall-router \textit{mainfw }and offers services accessible from the external network, while \textit{client} and \textit{internal server} networks are behind a second line of defence (represented by the internal firewall-router \textit{intfw}). The latter offers services that may be used only by hosts in the private network, whereas the former does not offer any services.
    
    All hosts are already configured (however, minor adjustment may be made), with the exception of the firewalls, that have yet to be created. 
    
    
    \section{Setup of the infrastructure}
    \subsection{Disabling checksum offload}
    The command \texttt{ethtool -K eth0 tx off} was added to every \texttt{.startup} file. This disables the checksum computation offload to the network card; instead, the hosts rely on the CPU to calculate the packet checksums. It is slower, but creates less problems with \opn.
    In \opn, checksum offload is disabled by default.
    
    \subsection{Enabling recursive DNS queries}
    Recursive DNS queries are not permitted, but this clashes with the fact that client hosts are allowed to retrieve web pages from the internet. Therefore, it has been decided to allow recursive DNS queries adding the clause \texttt{recursion yes;} in \texttt{dns/etc/named.conf}, section \texttt{options}.
    
    It has also decided that hosts in the \textit{DMZ} and in the \textit{internal server} network should not be interested in retrieving IP addresses of external websites. Hence, recursive DNS queries have been allowed only for \textit{client} network.
    
    \subsection{Creating and configuring the VMs}
    Create in \vb two virtual machine, one for \mainfw and the other for \intfw, each with its own disk. Download the ISO installer from \opn's \href{https://opnsense.org/download/}{official website} and add it to the virtual machines. \href{https://docs.opnsense.org/manual/install.html}{Install} \opn in both machine, then power them off and remove the ISO.
    
    Start the lab, then run the script \texttt{confgure.sh}\footnote{it requires root privileges}. The script assigns a client IP to the host and creates a valid route to the internal network. In this way, the host acts like a client when connecting to the internal network. Using the output of the script, configure the virtual machines as follows: in \mainfw, assign a NAT connection to the first network interface, DMZ to the second and Firewalls to the third; in \intfw, assign Firewalls to the first network interface, Server to the second and Client to the third. These steps must be repeated every time the lab restart, as \kat changes the bridge names every time.
    
    \subsection{Configuring the interfaces}
    Power up both virtual machine, login as root and enter interface assignment menu. Use \texttt{em0} as WAN, \texttt{em1} as OPT1 and \texttt{em2} as LAN.
    
    Enter the IP address configuration menu. In \mainfw, configure WAN to use DHCP, assign 100.64.254.1/30 to LAN and 100.64.6.1/24 to OPT1; in \intfw, assign address 100.64.254.2/30 and gateway 100.64.254.1 to WAN, address 100.64.2.1/24 to LAN and 100.64.1.1/24 to OPT1.
    
    \subsection{Setting up \opn}
    In \mainfw, enter the shell and execute \texttt{route add -inet 100.64.0.0/16 -link \\ 100.64.254.2}. This is a temporary measure in order to access the web GUI from the host. From now on, all operations will be executed through the GUI, accessible at \url{https://100.64.254.1} for \mainfw and \url{https://100.64.2.1} for \intfw. In \mainfw, add route \texttt{100.64.0.0/16} using gateway \texttt{100.64.254.2}.
    
    Disable outbound NAT in \intfw (unnecessary, as it is an internal firewall) and outbound DNS in both machines (DNS servers are configured statically in each host). In \mainfw, set outbound NAT in manual mode and create a rule for NATting the traffic that leaves the private network.
    
    
    \section{Evaluation of the security policy}
    \fxnote{TODO}
    
    
    \section{Policy implementation in \opn}
    \fxnote{TODO}
    
    
    \section{Test of the configuration}
    In the root directory of each \kat  host there is an executable script \texttt{$\langle$host$\rangle$.test} that checks the firewall and DNS functionality.
    The return code is a 4-bit flag:
    \begin{itemize}
        \item \texttt{0001}: error on DNS resolution of internal hosts
        \item \texttt{0010}: error on DNS resolution of external hosts
        \item \texttt{0100}: error on internal web connectivity
        \item \texttt{1000}: error on external web connectivity.
    \end{itemize}
    
    Given that \textit{expect} is not installed and both \textit{ftp} and \textit{ssh} clients can not be reliably used with simple bash scripts, testing the corresponding protocols must be done manually, checking the connectivity for each host.
    
    
    \section{Final remarks}
    When checksum offload is activated, all packets passing through the firewall get corrupted. Disabling it on the host's virtual interfaces produce no effects, it must be done from the \kat hosts.
    
    In theory, outbound NAT should be disabled in \mainfw, as \vb already takes care of translating the IP addresses. In practice, disabling it conflicts with the configuration script.
\end{document}
